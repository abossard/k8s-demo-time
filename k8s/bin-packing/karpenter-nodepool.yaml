---
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: default
  annotations:
    kubernetes.io/description: NodePool configured for bin-packing demo with 2 vCPU, 4GB RAM nodes (1-3 nodes)
spec:
  # Limit total resources to constrain node count (1-3 nodes with 2 CPU + 4GB each)
  limits:
    cpu: "6"        # 3 nodes * 2 vCPUs = 6 total CPUs max
    memory: 16Gi    # 3 nodes * 4GB = 12GB total memory max
  
  # Node disruption settings for bin-packing demo
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 0s
    budgets:
    - nodes: 30%
  
  template:
    metadata:
      labels:
        kubernetes.azure.com/ebpf-dataplane: cilium
        workload-type: bin-packing-demo
        node-size: small
    spec:
      expireAfter: Never
      
      # Node class reference for AKS
      nodeClassRef:
        group: karpenter.azure.com
        kind: AKSNodeClass
        name: default
      
      # Requirements to match Azure VM sizes with exactly 2 vCPUs and 4GB RAM
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
          - amd64
        
        - key: kubernetes.io/os
          operator: In
          values:
          - linux
        
        # Capacity type: on-demand for predictable demo behavior
        - key: karpenter.sh/capacity-type
          operator: In
          values:
          - on-demand
        
        # Limit to SKU families that have 2 vCPU / 4GB options
        # - key: karpenter.azure.com/sku-family
        #   operator: In
        #   values:
        #   - B  # B-series burstable (B2s has 2 vCPU, 4GB)
        #   - A  # A-series (Standard_A2_v2 has 2 vCPU, 4GB)
        
        # Limit to exactly 2 vCPUs
        - key: karpenter.azure.com/sku-cpu
          operator: In
          values:
          - "2"
        
        # # Limit to 4GB memory (4096 MB)
        # - key: karpenter.azure.com/sku-memory
        #   operator: In
        #   values:
        #   - "4096"
      
      # Cilium startup taint
      startupTaints:
      - effect: NoExecute
        key: node.cilium.io/agent-not-ready
        value: "true"
